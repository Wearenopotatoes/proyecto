<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Emergencias en El Salvador</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <h1>Emergencias en El Salvador</h1>
  <div class="controls">
    <button onclick="clearEmergencias()">üóë Limpiar Emergencias</button>
  </div>
  <div id="map"></div>

  <script>
    let map = L.map('map').setView([13.7, -89.2], 8); // Enfocado en El Salvador
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    let markers = {};

    async function loadMarkers() {
      const res = await fetch('/get_messages');
      const data = await res.json();

      // Limpiar marcadores anteriores
      for (let id in markers) {
        map.removeLayer(markers[id]);
      }
      markers = {};

      // Agregar nuevos
      data.forEach(msg => {
        if (msg.lat && msg.lng) {
          let marker = L.marker([msg.lat, msg.lng], {icon: redIcon}).addTo(map);
          marker.bindPopup(`
            <b>Emergencia:</b> ${msg.message}<br>
            <button onclick="atendido('${msg.id}')">‚úÖ Atendido</button>
          `);
          markers[msg.id] = marker;
        }
      });
    }

    async function atendido(id) {
      await fetch('/mark_atendido/' + id, { method: 'POST' });
      if (markers[id]) {
        map.removeLayer(markers[id]); // Eliminar del mapa
        delete markers[id];
      }
    }

    async function clearEmergencias() {
      await fetch('/clear_messages', { method: 'POST' });
      loadMarkers();
    }

    // √çcono rojo para emergencias
    const redIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    loadMarkers();
    setInterval(loadMarkers, 5000);
  </script>
</body>
</html>
