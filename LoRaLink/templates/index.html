<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>‚ö° Se√±ales - LoRaLink ‚ö°</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <div class="container">
    <h1>‚ö° Se√±ales - LoRaLink ‚ö°</h1>

    {% if messages and messages|length > 0 %}
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Descripci√≥n</th>
            <th>Fecha/Hora</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for msg in messages %}
          <tr class="{{ msg.status }}">
            <td>{{ loop.index }}</td>
            <td>{{ msg.content }}</td>
            <td>{{ msg.timestamp }}</td>
            <td class="estado">{{ msg.status }}</td>
            <td>
              {% if msg.status != 'atendida' %}
                <form action="{{ url_for('mark_as_attended', msg_id=loop.index0) }}" method="post" style="display:inline;">
                  <button class="btn atender" type="submit">‚úÖ Atendida</button>
                </form>
              {% else %}
                <form action="{{ url_for('reset_message', msg_id=loop.index0) }}" method="post" style="display:inline;">
                  <button class="btn reset" type="submit">üîÑ Reestablecer</button>
                </form>
              {% endif %}
              <form action="{{ url_for('delete_message', msg_id=loop.index0) }}" method="post" style="display:inline;">
                <button class="btn eliminar" type="submit">üóë Eliminar</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <h2>Mapa de Se√±ales</h2>
      <div id="map" style="height: 500px; margin-top:20px; border-radius:12px;"></div>
    {% else %}
      <p class="no-data">‚ö† No hay se√±ales registradas</p>
      <div id="map" style="height: 500px; margin-top:20px; border-radius:12px;"></div>
    {% endif %}
  </div>

  <script>
    // --- Configurar mapa centrado y limitado a El Salvador ---
    // Centro aproximado de ES
    var map = L.map('map').setView([13.7, -89.2], 9);

    // L√≠mites del pa√≠s (aprox): Suroeste y Noreste
    var esBounds = L.latLngBounds(
      L.latLng(13.0, -90.2),  // SW
      L.latLng(14.5, -87.6)   // NE
    );

    // Fondo OSM
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Limitar el arrastre y el zoom para no salir de ES
    map.setMaxBounds(esBounds);
    map.on('drag', function() {
      map.panInsideBounds(esBounds, { animate: true });
    });
    map.setMinZoom(7); // evita alejar demasiado
    map.setMaxZoom(18);

    // Agregar marcadores de las se√±ales
    var messages = {{ messages | tojson }};
    var markerBounds = [];

    messages.forEach(function(msg) {
      if (msg.lat && msg.lng) {
        var m = L.marker([msg.lat, msg.lng]).addTo(map);
        m.bindPopup(
          "<b>Se√±al:</b> " + (msg.content || "Sin descripci√≥n") + "<br>" +
          "<b>Estado:</b> " + (msg.status || "pendiente") + "<br>" +
          "<b>Fecha:</b> " + (msg.timestamp || "")
        );
        markerBounds.push([msg.lat, msg.lng]);
      }
    });

    // Si hay se√±ales, ajustar zoom a los marcadores pero sin salir de ES
    if (markerBounds.length > 0) {
      var bounds = L.latLngBounds(markerBounds);
      // Intersecci√≥n con los l√≠mites de ES para no salirse
      var padded = bounds.pad(0.2); // margen visual
      // Ajuste final respetando esBounds
      var finalBounds = L.latLngBounds(
        [
          Math.max(padded.getSouth(), esBounds.getSouth()),
          Math.max(padded.getWest(), esBounds.getWest())
        ],
        [
          Math.min(padded.getNorth(), esBounds.getNorth()),
          Math.min(padded.getEast(), esBounds.getEast())
        ]
      );
      map.fitBounds(finalBounds);
    } else {
      // Si no hay se√±ales, mu√©strate sobre ES
      map.fitBounds(esBounds);
    }
  </script>
</body>
</html>
